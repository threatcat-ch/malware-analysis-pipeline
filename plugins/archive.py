import argparse
import datetime
import json
import sys
import pathlib
import re
import os
import subprocess
import time
import logging

from plugins.abstract_plugin import AbstractPlugin
from utils.state import State
from pathlib import Path

class_name = 'Archive'

class Archive(AbstractPlugin):

    def __init__(self):
        super().__init__()
        self.archive_list_7z = State.config['archives']['archive_list_7z'].split(',')
        self.archive_list_unrar = State.config['archives']['archive_list_unrar'].split(',')
        self.mimetype_list = State.config['mimetype_to_analyze']['mimetype_list'].split(',')
        self.todo_path = ''

   
    def run(self, args):
        logging.info("Run Archive Plugin")
        if not State.path:
            logging.info("No path to decompress a file")
            raise Exception("No path to decompress a file")
        self.todo_path = str(State.path)

        for file in os.listdir(State.path):
            logging.info(f"Check file: {file}")
            archive_tool = self.check_archive(file)
            State.attachment_name = file
            if archive_tool == '7z' or archive_tool == 'unrar':
                self.decompress_archive(file, archive_tool)
            return
 
    # Check if file is an executable
    def check_mimelist(self, todo_path, file):
        mime_type_check = subprocess.run(['file', '-b', '--mime-type', todo_path + '/' + file], stdout=subprocess.PIPE)
        for mime_type in self.mimetype_list:
            if mime_type_check.stdout.decode('utf-8').strip() == mime_type:
                logging.info(f"File is in mimetype list: {file}")
                return True
        logging.info(f"File is not in mimetype list: {file}")
        return False

    # Check if file is an archive        
    def check_archive(self, file):
        archive_file_mime = subprocess.run(['file', '-b', '--mime-type', self.todo_path + '/' + file], stdout=subprocess.PIPE)
        logging.info(f"Mime-Type of {file}: {archive_file_mime.stdout.decode('utf-8').strip()}")
        
        for archive_type in self.archive_list_7z:
            if archive_file_mime.stdout.decode('utf-8').strip() == archive_type:
                logging.info(f"7z archive found: {file}")
                return '7z'
        for archive_type in self.archive_list_unrar:
            if archive_file_mime.stdout.decode('utf-8').strip() == archive_type:
                logging.info(f"rar archive found: {file}")
                return 'unrar'
        
        logging.info(f"File is not an archive: {file}")
        return False
        
    def decompress_archive(self, file, archive_tool):
        if archive_tool == '7z':
            zip_file = subprocess.run(['7z', 'x', '-y', self.todo_path + '/' + file, '-o' + self.todo_path + '/'], stdout=subprocess.PIPE)
            logging.info(f"Decompressed archive (with 7z): {file}")
            return
        elif archive_tool == 'unrar':
            unrar_file = subprocess.run(['unrar', 'e', '-y', self.todo_path  + '/' + file, self.todo_path + '/'], stdout=subprocess.PIPE)
            logging.info(f"Decompressed archive (with unrar): {file}")
            return
        else:
            logging.info("No archive tool found to decompress: {file}")
            raise Exception("No archive tool found to decompress: {file}")